name: DruOS Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Tier 1: Fast unit tests (every commit)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run unit tests
        run: |
          pnpm test:unit
          
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unit

  # Tier 2: CLI and SDK smoke tests (every PR)
  smoke-tests:
    name: Smoke Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
      - uses: actions/checkout@v3
      
      - uses: docker/setup-buildx-action@v2
        if: matrix.os == 'ubuntu-latest'
        
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build artifacts
        run: |
          pnpm build
          
      - name: Test CLI
        run: |
          cd packages/devkit-cli
          pnpm test:smoke
          
      - name: Test SDK (Node)
        run: |
          cd packages/runtime-sdk
          pnpm test:smoke
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.os }}
          path: |
            **/test-results.xml
            **/coverage/

  # Tier 3: Full E2E tests (nightly + manual)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[e2e]')
    
    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
          
    steps:
      - uses: actions/checkout@v3
      
      - uses: docker/setup-buildx-action@v2
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build kernel and initramfs
        run: |
          docker-compose build
          docker-compose run kernel-builder
          docker-compose run initramfs-builder
          
      - name: Start test server
        run: |
          pnpm dev:server &
          npx wait-on http://localhost:3000 -t 30000
          
      - name: Run E2E tests
        run: |
          pnpm test:e2e
        env:
          SELENIUM_URL: http://localhost:4444
          BASE_URL: http://localhost:3000
          
      - name: Test templates
        run: |
          for template in devtools-sandbox education-lab ai-sandbox; do
            echo "Testing $template..."
            pnpm test:template --template=$template
          done
          
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-artifacts
          path: |
            tests/_artifacts/
            screenshots/
            logs/

  # Device bridge tests
  device-tests:
    name: Device Bridge Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Test HTTP device
        run: |
          cd packages/runtime-sdk
          pnpm test tests/devices/http.test.ts
          
      - name: Test Storage device
        run: |
          cd packages/runtime-sdk
          pnpm test tests/devices/storage.test.ts
          
      - name: Test Logger device
        run: |
          cd packages/runtime-sdk
          pnpm test tests/devices/logger.test.ts

  # Performance tests
  perf-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'schedule'
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build optimized artifacts
        run: |
          NODE_ENV=production pnpm build
          
      - name: Run performance benchmarks
        run: |
          pnpm test:perf
          
      - name: Check performance regression
        run: |
          node scripts/check-perf-regression.js
          
      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: perf-results/

  # Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Run audit
        run: |
          pnpm audit --audit-level moderate
          
      - name: Check licenses
        run: |
          pnpm licenses list
          
      - name: SAST scan
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Report results
  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [unit-tests, smoke-tests, device-tests]
    if: always()
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        
      - name: Generate report
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Device Tests | ${{ needs.device-tests.result }} |" >> $GITHUB_STEP_SUMMARY
